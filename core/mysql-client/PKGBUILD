# $Id$
# Maintainer: Andrea Scarpino <andrea@archlinux.org>
# Contributor: Douglas Soares de Andrade <douglas@archlinux.org>

pkgbase=mysql
pkgname=('libmysqlclient' 'mysql-clients' 'mysql')
pkgver=5.5.29
pkgrel=1
arch=('i686' 'x86_64')
license=('GPL')
url="https://www.mysql.com/products/community/"
makedepends=('cmake' 'openssl' 'zlib')
options=('!libtool')
source=("http://ftp.gwdg.de/pub/misc/mysql/Downloads/MySQL-5.5/${pkgbase}-${pkgver}.tar.gz"
        'my.cnf' 'mysqld-post.sh' 'mysqld-tmpfile.conf'
	'patch-extra_CMakeLists.txt'
	'patch-include_myisam.h'
	'patch-support-files_CMakeLists.txt'
	'patch-extra_yassl_taocrypt_src_integer.cpp'
	'patch-man_CMakeLists.txt'
	'patch-CMakeLists.txt'
	'patch-include_CMakeLists.txt'
	'patch-mysys_default.c'
	'patch-client_CMakeLists.txt'
	'patch-include_my_compare.h'
	'patch-sql_sys_vars.cc'
	'patch-sql_CMakeLists.txt'
	'patch-scripts_mysqld_safe.sh')
md5sums=('e6b9f9cb82e990bd8f0474df7462904e'
         '2716c6ec912d791abb369579a95ab527'
         '35d71489f58ae6c02f5d3281b2578c79'
         '2fa6e456964d4ff5e6d4f9ff0126aed6'
         'bebf67ff82855a41809ec0abc115991e'
         'ccb4b565784d6d4f0493d56c16902c69'
         'db49fc7de34b89747f0ed287dd81597d'
         '728e0a7521b330c3696ee8aac43dbc2e'
         'e922459f4da9ca93c83fb3ffe039d63c'
         'a669474fd34270c27d1f8913ba0f0ea9'
         '95617bf2c55e270b879a02f74cd6d03a'
         'fcb52c109a11e9252ef6bd5c24018865'
         '5d00bab911db5ec601ac025dbf998c48'
         '5587191c167ebd33b3ed9946032cd2f1'
         '5aa461540f58e699c13ce03cbf3a9f3c'
         '5e1f91f3419dc28fb293633f0019df0e'
         '3b97497dc7e075bcd72460d24e2001a1')


build() {
  # CFLAGS/CXXFLAGS as suggested upstream
  export LDFLAGS="$LDFLAGS -L/usr/local/lib"
  export CFLAGS="${CFLAGS} -I/usr/local/include"
  export CPPFLAGS="${CPPFLAGS} -I/usr/local/include"
 
  mkdir ${srcdir}/build
  cd ${srcdir}/build

  cmake ../${pkgbase}-${pkgver} \
    -DINSTALL_DOCDIR="share/doc/mysql" \
    -DINSTALL_DOCREADMEDIR="share/doc/mysql" \
    -DINSTALL_INCLUDEDIR="include/mysql" \
    -DINSTALL_INFODIR="info" \
    -DINSTALL_LIBDIR="lib/mysql" \
    -DINSTALL_MANDIR="man" \
    -DINSTALL_MYSQLDATADIR="/var/db/mysql" \
    -DINSTALL_MYSQLSHAREDIR="share/mysql" \
    -DINSTALL_MYSQLTESTDIR="share/mysql/tests" \
    -DINSTALL_PLUGINDIR="lib/mysql/plugin" \
    -DINSTALL_SBINDIR="libexec" \
    -DINSTALL_SCRIPTDIR="bin" \
    -DINSTALL_SHAREDIR="share" \
    -DINSTALL_SQLBENCHDIR="share/mysql" \
    -DINSTALL_SUPPORTFILESDIR="share/mysql" \
    -DWITH_LIBEDIT=0 \
    -DWITH_LIBWRAP=1 \
    -DWITH_SSL=bundled \
    -DCMAKE_C_FLAGS="-fPIC ${CFLAGS} -fno-strict-aliasing -DBIG_JOINS=1 -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-fPIC ${CXXFLAGS} -fno-strict-aliasing -DBIG_JOINS=1 -felide-constructors -fno-rtti" \
    -DCMAKE_INSTALL_PREFIX:PATH="/usr/local/" \
    -DTHREADS_HAVE_PTHREAD_ARG:BOOL=YES
  
  cd "${srcdir}"/${pkgbase}-${pkgver}
  patch -p0 -i "${srcdir}/patch-extra_CMakeLists.txt"
  patch -p0 -i "${srcdir}/patch-include_myisam.h"
  patch -p0 -i "${srcdir}/patch-support-files_CMakeLists.txt"
  patch -p0 -i "${srcdir}/patch-extra_yassl_taocrypt_src_integer.cpp"
  patch -p0 -i "${srcdir}/patch-man_CMakeLists.txt"
  patch -p0 -i "${srcdir}/patch-CMakeLists.txt"
  patch -p0 -i "${srcdir}/patch-include_CMakeLists.txt"
  patch -p0 -i "${srcdir}/patch-mysys_default.c"
  patch -p0 -i "${srcdir}/patch-client_CMakeLists.txt"
  patch -p0 -i "${srcdir}/patch-include_my_compare.h"
  patch -p0 -i "${srcdir}/patch-sql_sys_vars.cc"
  patch -p0 -i "${srcdir}/patch-sql_CMakeLists.txt"
  patch -p0 -i "${srcdir}/patch-scripts_mysqld_safe.sh"
 
  cd ${srcdir}/build
  make
}

package_libmysqlclient(){
  pkgdesc="MySQL client libraries"
  depends=('openssl')
  cd ${srcdir}/build
  for dir in include libmysql libmysqld libservices; do
    make -C ${dir} DESTDIR="${pkgdir}" install
  done

  install -d "${pkgdir}"/usr/local/bin
  install -m755 scripts/mysql_config "${pkgdir}"/usr/local/bin/
  install -d "${pkgdir}"/usr/share/man/man1
  for man in mysql_config mysql_client_test_embedded mysqltest_embedded; do
    install -m644 "${srcdir}"/${pkgbase}-${pkgver}/man/$man.1 "${pkgdir}"/usr/share/man/man1/$man.1
  done
}

package_mysql-clients(){
  pkgdesc="MySQL client tools"
  depends=('libmysqlclient')
  
  make -C client DESTDIR="${pkgdir}" install

  # install man pages
  install -d "${pkgdir}"/usr/share/man/man1
  for man in mysql mysqladmin mysqlcheck mysqldump mysqlimport mysqlshow mysqlslap; do
    install -m644 "${srcdir}"/${pkgbase}-${pkgver}/man/$man.1 "${pkgdir}"/usr/share/man/man1/$man.1
  done

  # provided by mysql
  rm "${pkgdir}"/usr/local/bin/{mysql_{plugin,upgrade},mysqlbinlog,mysqltest}
}

package_mysql(){
  pkgdesc="A fast SQL database server"
  backup=('etc/mysql/my.cnf')
  install=mysql.install
  depends=('mysql-clients' 'systemd-tools')
  options=('emptydirs')

  make DESTDIR="${pkgdir}" install

  install -dm644 "${pkgdir}"/etc/mysql/
  install -dm644 "${pkgdir}"/etc/rc.d/
  install -dm644 "${pkgdir}"/usr/local/bin/mysqld-post
  install -dm644 "${pkgdir}"/usr/lib/tmpfiles.d/
  install -m755 "${srcdir}"/my.cnf "${pkgdir}"/etc/mysql/
  install -m755 "${srcdir}"/mysqld.rc "${pkgdir}"/etc/rc.d/mysqld
  install -m755 "${srcdir}"/mysqld-post.sh "${pkgdir}"/usr/bin/mysqld-post
  install -m644 "${srcdir}"/mysqld-tmpfile.conf "${pkgdir}"/usr/lib/tmpfiles.d/mysqld.conf

  # provided by libmysqlclient
  rm "${pkgdir}"/usr/local/bin/{mysql_config,mysql_client_test_embedded,mysqltest_embedded}
  rm "${pkgdir}"/usr/local/lib/libmysql*
  rm -r "${pkgdir}"/usr/local/include/
  rm "${pkgdir}"/usr/share/man/man1/{mysql_config,mysql_client_test_embedded,mysqltest_embedded}.1
  
  # provided by mysql-clients
  rm "${pkgdir}"/usr/local/bin/{mysql,mysqladmin,mysqlcheck,mysqldump,mysqlimport,mysqlshow,mysqlslap}
  rm "${pkgdir}"/usr/share/man/man1/{mysql,mysqladmin,mysqlcheck,mysqldump,mysqlimport,mysqlshow,mysqlslap}.1

  # not needed
  rm -r "${pkgdir}"/usr/{data,mysql-test,sql-bench}
  rm "${pkgdir}"/usr/share/man/man1/mysql-test-run.pl.1

  install -dm700 "${pkgdir}"/var/lib/mysql
}

